export{SmootScroll,AnimationControl,loadData,setStartPositionAndScroll,redirectToTarget,transition,webGL};import{drawProjects}from"./work.js";let webGL={};window.addEventListener("popstate",redirectToTarget),window.addEventListener("resize",resize()),document.addEventListener("DOMContentLoaded",()=>{setDataWebGL(),document.getElementById("main").prepend(webGL.data.canvas),insertPageContent(window.location.pathname.slice(1)),document.querySelectorAll(".menu-item").forEach(e=>e.addEventListener("click",redirectToTarget)),document.querySelector(".menu-call").addEventListener("click",()=>{document.onclick=e=>{let t=document.querySelector(".menu-item-group");t.classList.contains("show-adaptive-menu")?e.target.closest(".menu-item-group")||(t.classList.add("hide-adaptive-menu"),t.classList.remove("show-adaptive-menu"),document.onclick=null):(t.classList.add("show-adaptive-menu"),t.classList.remove("hide-adaptive-menu"))}})});class SmootScroll{constructor(e,t){this.scrollable=e,this.speed=t||.15}position=0;animation;customHandler;animate=()=>{if(window.scrollY==this.position)window.cancelAnimationFrame(this.animation),this.animation=null;else{let e=(window.scrollY-this.position)*this.speed;this.animation=window.requestAnimationFrame(this.animate),this.position+=window.scrollY<this.position?Math.floor(e):Math.ceil(e),this.scrollable.style.transform=`matrix(1,0,0,1,0,${-this.position})`,this.customHandler&&this.customHandler(this.position)}};addListener=()=>{let e;window.onscroll=()=>{document.body.hasAttribute("data-resizing")?(this.position+=window.scrollY-this.position,this.scrollable.style.transform=`matrix(1,0,0,1,0,${-this.position})`):e||(e=!0,setTimeout(()=>{this.animation||this.animate(),e=!1},50))}};removeListener=()=>window.onscroll=null}class AnimationControl{static id;static run(e={duration:duration,iteration:iteration,timing:timing,preliminary:preliminary,draw:draw},t){if(e){let a=performance.now(),n=()=>{let o=(performance.now()-a)/e.duration;e.iteration?this.id=requestAnimationFrame(n):o>=1?o=1:this.id=requestAnimationFrame(n),e.draw(e.timing(o)),1==o&&t&&!e.iteration&&t()};e.preliminary&&e.preliminary(),n(a)}else{let e=()=>{t(),this.id=requestAnimationFrame(e)};e()}}static cancel(){cancelAnimationFrame(this.id),this.id=null}}class ClickEffect{static id;static texture;static cropCoord;static options={duration:800,iteration:!1,timing:e=>e<.5?4*Math.pow(e,3):1-Math.pow(-2*e+2,3)/2,preliminary:()=>{this.id=document.querySelector('.page-2 [data-enable="true"]').getAttribute("data-id"),this.texture=webGL.data.createAndSetupTexture(new Uint8Array([10,10,10,1]))},draw:e=>{webGL.data.prepareCanvas();for(let t=0;t<3;t++){let a;1===t?(webGL.uniform.u_Band.value=e<.5?-.8*e:-.8*(1-e),webGL.uniform.u_CropCoord.value=0,webGL.uniform.u_Matrix.value=Matrix_4x4.multiply(Matrix_4x4.setPerspectiveProjection(),Matrix_4x4.setView(),Matrix_4x4.setTranslate(0,1.14-1.14*e,-2)),a=this.texture):(webGL.uniform.u_Band.value=0,webGL.uniform.u_CropCoord.value=0===t?0:this.cropCoord,webGL.uniform.u_Matrix.value=Matrix_4x4.multiply(Matrix_4x4.setPerspectiveProjection(),Matrix_4x4.setView(),Matrix_4x4.setTranslate(0,0,-2)),a=webGL.texture[this.id]),webGL.data.drawFrame(webGL.program,webGL.geometry,webGL.uniform,a)}}}}function resize(){let e,t;return function(){let a=document.querySelector(".resizing"),n=window.location.pathname.slice(1);if(clearTimeout(e),e=setTimeout(()=>{let e=document.getElementById("scrollable");if(setTimeout(()=>{t=!1,document.body.removeAttribute("data-resizing"),a.removeAttribute("style"),"home"===n&&document.querySelector(".no-transition")?.classList.remove("no-transition")},100),document.body.style.height=e.parentNode.clientHeight+e.parentNode.offsetTop+"px",webGL.data.canvas.width=window.innerWidth,webGL.data.canvas.height=window.innerHeight,"home work".includes(n))if(setGeometry(),webGL.data.prepareCanvas(null,!0),"home"===n){let e=+window.sessionStorage.getItem("pageNumber"),t=document.querySelector(".page-"+e);if(1===e||3===e){let e,a=t.querySelector(".item-title-group");e=[-100,-300,-500,-900].includes(new WebKitCSSMatrix(getComputedStyle(a).transform).m42)?-a.offsetParent.offsetTop:-a.offsetParent.offsetTop-a.offsetTop,t.querySelector('[data-enable="true"]').style.transform=`matrix(1,0,0,1,0,${e})`}else 2===e&&(document.querySelector(".hide-current-item")?(webGL.uniform.u_AnimationMode.value=2,openProject()):webGL.data.drawFrame(webGL.program,webGL.geometry,webGL.uniform,webGL.texture[0]))}else webGL.uniform.u_AnimationMode.value=2,document.querySelector(".hide-current-item")?openProject():drawProjects(!1,window.scrollY);document.body.clientWidth>520&&(document.querySelector(".menu-item-group").className="menu-item-group")},200),!t&&(t=!0,document.body.setAttribute("data-resizing",""),a.style.visibility="visible","home"===n)){let e=+window.sessionStorage.getItem("pageNumber");1!==e&&3!==e||document.querySelector(`.page-${e} [data-enable="true"]`).classList.add("no-transition")}}}function insertPageContent(e){let t=performance.now(),a=import(`./${e}.js`);loadData("node",`./templates/${e}.php`).then(n=>{let o=performance.now()-t,i=document.getElementById("main"),r=document.getElementById("canvas_webgl");setTimeout(()=>{a.then(t=>t[e]()),n.querySelectorAll(".redirection").forEach(e=>e.addEventListener("click",redirectToTarget)),AnimationControl.id&&AnimationControl.cancel(),"home work".includes(e)&&(setGeometry(),webGL.data.prepareCanvas(null,!0)),"home"==e?i.removeAttribute("data-state"):i.setAttribute("data-state","belowe"),"work"==e?Object.assign(r.style,{visibility:"visible",top:0}):r.style.visibility="hidden",i.removeAttribute("style"),document.getElementById("scrollable").replaceChildren(n),setStartPositionAndScroll(e)},o<300?300-o:0)})}function redirectToTarget(e){let t,a=document.getElementById("main");e.preventDefault(),"popstate"!==e.type?(t=e.currentTarget.pathname.slice(1),window.history.pushState(null,null,t),e.currentTarget.classList.contains("redirection")&&e.currentTarget.classList.add("disable")):t=e.target.location.pathname.slice(1),window.onscroll instanceof Function&&(window.onscroll=null),window.onwheel instanceof Function&&(window.onwheel=null),document.querySelector(`link[href*="${t}"]`)||document.head.insertAdjacentHTML("beforeend",`<link rel="stylesheet" href="./styles/${t}.css">`),Object.assign(a.style,{opacity:getComputedStyle(a).opacity,transform:getComputedStyle(a).transform}),a.setAttribute("data-state","hidden"),document.title=""+(t[0].toUpperCase()+t.slice(1)),document.querySelector(".menu").classList.remove("hide-current-item"),document.querySelector(".current-item").classList.remove("current-item"),document.querySelector(`.menu-item[href=${t}]`).classList.add("current-item"),insertPageContent(t)}function setDataWebGL(){let e=document.body.getAttribute("data-project").toUpperCase().split(",");webGL.data=new WebGL,webGL.data.prepareCanvas({r:10,g:10,b:10,a:1}),Promise.all(["vertex","fragment"].map(e=>loadData("text",`./shaders/${e}_shader.glsl`))).then(t=>{webGL.program=webGL.data.createShaderProgram(t[0],t[1]),webGL.texture=new Array(e.length).fill(webGL.data.createAndSetupTexture(new Uint8Array([238,238,238,1]))),new FontFace("Texture_Font","url(./fonts/Texture_Font.woff2)").load().then(t=>{document.fonts.add(t);for(let t=0;t<e.length;t++)setTimeout(()=>webGL.texture[t]=webGL.data.createAndSetupTexture(getImageOnCanvas(e[t],1400,700)))})})}function setGeometry(e,t){let a=e??Math.min(document.getElementById("scrollable").clientWidth,"/home"==window.location.pathname?1100:1400),n=t??a/2,o=Math.round(a/72),i=Math.round("/home"==window.location.pathname?o:n/72);webGL.geometry=WebGLGeometry.createPlane(webGL.data.canvas,a,n,o,i,!0),webGL.data.initializeBuffer(webGL.geometry,!0),webGL.data.setAttribute(webGL.program,webGL.geometry,{a_Position:2,a_TextureCoords:2}),webGL.uniform=setDefaultUniform()}function setDefaultUniform(){return{u_AnimationMode:{type:"int",value:0},u_Distance:{type:"float",value:0},u_Distortion:{type:"float",value:0},u_Progress:{type:"float",value:0},u_Band:{type:"float",value:0},u_Wave:{type:"float",value:0},u_CanvasWidthRatio:{type:"float",value:Math.max(-.002*webGL.data.canvas.clientWidth+6,2)},u_Matrix:{type:"mat4",value:Matrix_4x4.multiply(Matrix_4x4.setPerspectiveProjection(),Matrix_4x4.setView(),Matrix_4x4.setTranslate(0,0,-2))}}}function setStartPositionAndScroll(e,t){let a=document.getElementById("scrollable");a.style.transform="matrix(1,0,0,1,0,0)","work contacts".includes(e)||!0===e?(new SmootScroll(a).addListener(),document.body.style.height=(t??a.parentNode.clientHeight)+"px",window.scrollTo(0,0)):(window.onscroll=null,document.body.style.height=0)}async function loadData(e,t){let a=await fetch(t);switch(e){case"node":let e=document.createElement("template");return e.innerHTML=await a.text(),e.content;case"text":return a.text();case"bitmap":let t=await a.blob();return createImageBitmap(t,{imageOrientation:"flipY"});default:throw new TypeError("Incorrect response type specified")}}function transition(e){e.preventDefault();let t,a=performance.now(),n=window.location.pathname,o="/home"===n?1100:300,i=document.createElement("canvas"),r=i.getContext("2d");loadData("node",`./templates/work/${e.currentTarget.pathname}.php`).then(e=>{let t=performance.now()-a;setTimeout(()=>{setTimeout(()=>{let e=document.querySelector(".current-item"),t=e.parentElement.children,a=document.querySelector(".back-item");for(let n=0;n<t.length;n++)t[n]===e&&(a.style.left=`calc(100% * ${1/t.length*n})`);document.querySelector(".menu").classList.add("hide-current-item"),a.addEventListener("click",backToListWorks),document.getElementById("main").setAttribute("data-state","belowe"),document.querySelectorAll("video[data-ratio]").forEach(e=>e.play()),webGL.uniform=setDefaultUniform(),webGL.uniform.u_AnimationMode.value=2},100),document.getElementById("scrollable").replaceChildren(e),document.getElementById("canvas_webgl").style.top=0,openProject(!0)},t<o?o-t:0)}),"/home"===n?(i.setAttribute("width",1400),i.setAttribute("height",700),r.font="180px Texture_Font",t=document.querySelector('.page-2 [data-enable="true"]').textContent,window.onwheel=null,webGL.uniform.u_CropCoord={type:"float",value:0},ClickEffect.cropCoord=(i.width-r.measureText(t.toUpperCase()).width)/i.width/2,AnimationControl.run(ClickEffect.options,()=>{document.getElementById("main").setAttribute("data-state","hidden"),webGL.uniform.u_CropCoord.value=0}),Object.assign(document.querySelector(".project-source").style,{pointerEvents:"none",cursor:"default"})):document.getElementById("main").setAttribute("data-state","hidden")}function openProject(e){let t=document.querySelectorAll("img[data-ratio],video[data-ratio]"),a=new SmootScroll(document.getElementById("scrollable")),n=document.querySelector(".grid"),o=Matrix_4x4.multiply(Matrix_4x4.setPerspectiveProjection(),Matrix_4x4.setView()),i=webGL.data.createAndSetupTexture(new Uint8Array([238,238,238,1])),r=[],l=0,s=window.innerWidth<1200?.05*window.innerWidth:60;t.forEach((a,n)=>{let o,d,c=a.clientWidth,u=Math.round(a.clientWidth*a.getAttribute("data-ratio")),m=webGL.data.canvas.clientWidth/webGL.data.canvas.clientHeight,w=Math.round(c/72),p=Math.round(u/72);a.style.height=u+"px",[o,d]=WebGLHelper.convertCoords(webGL.data.canvas,a.offsetTop+a.offsetParent.offsetTop,a.getBoundingClientRect().left),r[n]={geometry:WebGLGeometry.createPlane(webGL.data.canvas,c,u,w,p,!0,!0,!0),top:o*m,left:d/m,y:-o*m,texture:i},e?["load","canplay"].forEach(e=>{a.addEventListener(e,()=>{"canplay"===e&&(r[n].source=a),r[n].texture=webGL.data.createAndSetupTexture(a),a.removeAttribute("style")},{once:!0})}):("video"==a.localName&&(r[n].source=a),r[n].texture=webGL.data.createAndSetupTexture(a),a.removeAttribute("style")),a.parentElement.classList.contains("mobile")||a.parentElement.nextElementSibling?.classList.contains("wide-mobile")||(l+=u,n!==t.length-1&&(l+=s))}),setStartPositionAndScroll(!0,n.offsetTop+l+parseFloat(getComputedStyle(n).marginBottom)),a.customHandler=e=>{let t=45e-5*(window.scrollY-e);for(let t=0;t<r.length;t++)r[t].y=-r[t].top+e/(webGL.data.canvas.clientHeight/2);webGL.uniform.u_Band.value=t>=0?Math.min(t,.06):Math.max(t,-.06),webGL.uniform.u_Progress.value=Math.max(-Math.abs(4.5*t),-.45)},a.addListener(),AnimationControl.cancel(),AnimationControl.run(null,()=>{webGL.data.prepareCanvas();for(let e=0;e<r.length;e++)webGL.data.initializeBuffer(r[e].geometry),webGL.uniform.u_Matrix.value=Matrix_4x4.multiply(o,Matrix_4x4.setTranslate(r[e].left,r[e].y,-2)),webGL.data.drawFrame(webGL.program,r[e].geometry,webGL.uniform,r[e].source?webGL.data.updateTexture(r[e].texture,r[e].source):r[e].texture)})}function getImageOnCanvas(e,t,a){let n,o,i,r=document.createElement("canvas"),l=r.getContext("2d"),s="  "+e;r.setAttribute("width",t),r.setAttribute("height",a),l.font="180px Texture_Font",l.textAlign="center",l.textBaseline="middle",o=l.measureText(s).width,n=a/4,i=Math.ceil(t/o),l.fillStyle="#0a0a0a",l.fillRect(0,0,t,a),l.fillStyle="#eeeeee";for(let t=0;t<i;t++)e+=s;for(let a=0;a<5;a++)i%2==0?a%2==0?l.fillText(e,t/2,n*a):l.fillText(e,(t+o)/2,n*a):a%2==0?l.fillText(e,(t+o)/2,n*a):l.fillText(e,t/2,n*a);return r}function backToListWorks(e){e.preventDefault(),document.querySelector(".menu").classList.remove("hide-current-item"),document.getElementById("main").setAttribute("data-state","hidden"),insertPageContent(window.location.pathname.slice(1))}